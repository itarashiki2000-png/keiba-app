<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>競馬アプリ土曜版</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #000;
        color: #fff;
    }
    h2 { margin-bottom: 0; }

    .top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .button-group button {
        padding: 8px 14px;
        margin: 3px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background: #555;
        color: #fff;
        font-size: 16px;
    }
    .button-group button.active {
        background: #3A74D8;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: #000;
        color: #fff;
    }
    table th, table td {
        border: 1px solid #555;
        padding: 4px;
        text-align: center;
    }

    table input, table select {
        font-size: 14px;
        background: #444;
        color: #fff;
        border-radius: 4px;
        border: 1px solid #777;
    }
    table input[readonly] {
        background: #222;
        color: #fff;
    }

    .w1 { width: 45px; }
    .w2 { width: 40px; }
    .w3 { width: 70px; }

    .bottom-container {
        display: flex;
        margin-top: 25px;
        gap: 20px;
    }
    .rank-box {
        width: 33%;
        border: 1px solid #555;
        padding: 10px;
    }
    .result-box {
        width: 67%;
        border: 1px solid #555;
        padding: 10px;
    }

    .memo {
        width: 100%;
        height: 70px;
        font-size: 14px;
        background: #111;
        color: #fff;
        border: 1px solid #555;
        border-radius: 4px;
    }

    .slider-container {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
    }

    .toggle-btn {
        padding: 6px 14px;
        margin-right: 8px;
        margin-top: 4px;
        background: #555;
        color: #fff;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }
    .toggle-btn.active {
        background: #3A74D8;
    }

    .top-buttons button,
    .small-btn {
        padding: 8px 14px;
        margin-left: 6px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background: #777;
        color: #fff;
        font-size: 14px;
    }

    .small-btn {
        padding: 4px 10px;
        margin-left: 4px;
        margin-right: 4px;
    }
</style>
</head>
<body>

<h2>競馬アプリ（土曜版）</h2>

<!-- 年月日 + 初期化 / CSV -->
<div class="top-row">
    <div>
        年月日：
        <input type="text" id="dateInput" style="font-size:16px;">
    </div>

    <div class="top-buttons">
        <button onclick="exportCSV()">CSV出力</button>
        <button onclick="resetData()">データ初期化</button>
    </div>
</div>

<!-- 開催ボタン -->
<div class="button-group" id="kaisaiButtons">
    <button onclick="selectKaisai(this,'東京')">東京</button>
    <button onclick="selectKaisai(this,'京都')">京都</button>
    <button onclick="selectKaisai(this,'中山')">中山</button>
    <button onclick="selectKaisai(this,'阪神')">阪神</button>
    <button onclick="selectKaisai(this,'その他')">その他</button>
</div>

<!-- レース番号 -->
<div class="button-group" id="raceButtons">
    <script>
        for (let i=1;i<=12;i++){
            document.write(`<button onclick="selectRace(this,${i})">${i}R</button>`);
        }
    </script>
</div>

<!-- コース＋距離＋最高点 -->
<div class="slider-container">
    コース：
    <select id="surface" onchange="saveData()">
        <option value="芝">芝</option>
        <option value="ダート">ダート</option>
    </select>

    ｜ 距離：
    <button class="small-btn" onclick="changeDistance(-1)">－</button>
    <input type="range" min="10" max="36" value="24" id="distance"
           oninput="updateDistance(); saveData();">
    <button class="small-btn" onclick="changeDistance(1)">＋</button>
    <span id="distanceLabel">24（2400m）</span>

    ｜ 最高点：
    <span id="avgScore">0.0</span>
</div>

<!-- 18頭テーブル -->
<table>
<thead>
<tr>
<th>馬番</th><th>馬体</th><th>タイム</th><th>騎手</th>
<th>過去1</th><th>過去2</th><th>過去3</th>
<th>馬合計</th><th>騎手点</th><th>総合点</th>
</tr>
</thead>
<tbody>

<script>
for (let i=1;i<=18;i++){
document.write(`
<tr>
<td>${i}</td>

<td>
<input id="body_${i}" class="w2"
       onkeydown="focusNext(event, ${i})"
       oninput="calcAll()">
</td>

<td>
<select id="time_${i}" class="w1" onchange="calcAll()">
<option value="0"></option>
<option value="8">8</option>
<option value="4">4</option>
<option value="2">2</option>
<option value="1">1</option>
</select>
</td>

<td><input id="jockey_${i}" class="w3" oninput="calcAll()" placeholder="0.23"></td>

<td>
<select id="past1_${i}" class="w1" onchange="calcAll()">
<option value="0">0</option><option value="1">1</option>
<option value="2">2</option><option value="3">3</option>
<option value="4">4</option>
</select>
</td>

<td>
<select id="past2_${i}" class="w1" onchange="calcAll()">
<option value="0">0</option><option value="1">1</option>
<option value="2">2</option><option value="3">3</option>
<option value="4">4</option>
</select>
</td>

<td>
<select id="past3_${i}" class="w1" onchange="calcAll()">
<option value="0">0</option><option value="1">1</option>
<option value="2">2</option><option value="3">3</option>
<option value="4">4</option>
</select>
</td>

<td><input id="pastTotal_${i}" class="w3" readonly></td>
<td><input id="jockeyP_${i}" class="w3" readonly></td>
<td><input id="total_${i}" class="w3" readonly></td>
</tr>
`);
}
</script>

</tbody>
</table>

<!-- 順位 + 予想 / 結果 -->
<div class="bottom-container">

<div class="rank-box">
<h3>順位</h3>
<div id="rankList"></div>
</div>

<div class="result-box">
<h3>予想</h3>

ペース予想：
<input type="range" min="1" max="5" value="3" id="pace" oninput="saveData()">
<br><br>

指名馬番：
<select id="pickHorse" onchange="saveData()">
<script>
for (let i=1;i<=18;i++){
    document.write(`<option value="${i}">${i}</option>`);
}
</script>
</select>
<br><br>

購入：<br>
<button type="button" class="toggle-btn toggle-buy" data-value="yes"
        onclick="setToggle('buy','yes')">○ 買う</button>
<button type="button" class="toggle-btn toggle-buy" data-value="no"
        onclick="setToggle('buy','no')">× 買わない</button>

<hr>

<h3>結果</h3>

的中：<br>
<button type="button" class="toggle-btn toggle-hit" data-value="yes"
        onclick="setToggle('hit','yes')">○ 的中</button>
<button type="button" class="toggle-btn toggle-hit" data-value="no"
        onclick="setToggle('hit','no')">× 不的中</button>
<br><br>

複勝オッズ：
<input id="oddsLow" class="w1" oninput="saveData()"> 〜
<input id="oddsHigh" class="w1" oninput="saveData()">
<br><br>

メモ：<br>
<textarea class="memo" id="memo" oninput="saveData()"></textarea>

</div>
</div>

<script>
// ◆ 土曜版の保存プレフィックス（ここだけ日曜と違う）
const STORAGE_PREFIX = "keiba_app_saturday";

const pastPoints = {0:0,1:10,2:8,3:6,4:3};

let selectedKaisai = "";
let selectedRace = 0;
let buyState = "";
let hitState = "";

//------------------------------
// 保存キー生成：開催×レース
//------------------------------
function getStorageKey(){
    if(!selectedKaisai || !selectedRace){
        return `${STORAGE_PREFIX}_temp`;
    }
    return `${STORAGE_PREFIX}_${selectedKaisai}_${selectedRace}`;
}

//------------------------------
// Enterキー → 馬体欄の次へ
//------------------------------
function focusNext(event, index){
    if(event.key === "Enter"){
        event.preventDefault();
        const next = index + 1;
        if(next <= 18){
            const el = document.getElementById(`body_${next}`);
            if(el) el.focus();
        }
    }
}

//------------------------------
// 距離 ±1 ボタン
//------------------------------
function changeDistance(delta){
    let slider = document.getElementById("distance");
    let v = parseInt(slider.value) || 10;
    v += delta;
    if(v < 10) v = 10;
    if(v > 36) v = 36;
    slider.value = v;
    updateDistance();
    saveData();
}

//------------------------------
// 画面の馬・レース関連項目をクリア
//（年月日は残す）
//------------------------------
function clearRaceFields(){
    // コース・距離・最高点
    document.getElementById("surface").value = "芝";
    document.getElementById("distance").value = 24;
    document.getElementById("distanceLabel").textContent = "24（2400m）";
    document.getElementById("avgScore").textContent = "0.0";

    // 馬データ
    for(let i=1;i<=18;i++){
        document.getElementById(`body_${i}`).value = "";
        document.getElementById(`time_${i}`).value = "0";
        document.getElementById(`jockey_${i}`).value = "";
        document.getElementById(`past1_${i}`).value = "0";
        document.getElementById(`past2_${i}`).value = "0";
        document.getElementById(`past3_${i}`).value = "0";
        document.getElementById(`pastTotal_${i}`).value = "";
        document.getElementById(`jockeyP_${i}`).value = "";
        document.getElementById(`total_${i}`).value = "";
    }

    // 予想・結果
    document.getElementById("pace").value = 3;
    document.getElementById("pickHorse").value = "1";
    buyState = "";
    hitState = "";
    document.querySelectorAll(".toggle-buy, .toggle-hit").forEach(btn=>{
        btn.classList.remove("active");
    });
    document.getElementById("oddsLow").value = "";
    document.getElementById("oddsHigh").value = "";
    document.getElementById("memo").value = "";
    document.getElementById("rankList").innerHTML = "";
}

//------------------------------
// 開催
//------------------------------
function selectKaisai(btn,name){
    document.querySelectorAll("#kaisaiButtons button")
        .forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedKaisai = name;
    if(selectedRace){
        loadDataForCurrentPair();
    }
}

//------------------------------
// レース
//------------------------------
function selectRace(btn,no){
    document.querySelectorAll("#raceButtons button")
        .forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedRace = no;
    if(selectedKaisai){
        loadDataForCurrentPair();
    }
}

//------------------------------
// 距離表示
//------------------------------
function updateDistance(){
    let v = document.getElementById("distance").value;
    document.getElementById("distanceLabel").textContent =
        `${v}（${v*100}m）`;
}

//------------------------------
// トグル（購入・的中）
//------------------------------
function setToggle(group, value){
    const cls = group === 'buy' ? '.toggle-buy' : '.toggle-hit';
    document.querySelectorAll(cls).forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.value === value);
    });
    if(group === 'buy') buyState = value;
    if(group === 'hit') hitState = value;
    saveData();
}

function applyToggle(group, value){
    if(!value) return;
    const cls = group === 'buy' ? '.toggle-buy' : '.toggle-hit';
    document.querySelectorAll(cls).forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.value === value);
    });
    if(group === 'buy') buyState = value;
    if(group === 'hit') hitState = value;
}

//------------------------------
// 計算：馬70点＋騎手30点に正規化
//------------------------------
function calcAll(){

    let horses = [];
    let sumHorseRaw = 0;
    let sumJockeyRaw = 0;

    // 1回目ループ：入力を集める & 合計
    for (let i=1;i<=18;i++){
        let body  = Number(document.getElementById(`body_${i}`).value) || 0;
        let time  = Number(document.getElementById(`time_${i}`).value) || 0;
        let jRaw  = Number(document.getElementById(`jockey_${i}`).value) || 0;
        let p1    = Number(document.getElementById(`past1_${i}`).value) || 0;
        let p2    = Number(document.getElementById(`past2_${i}`).value) || 0;
        let p3    = Number(document.getElementById(`past3_${i}`).value) || 0;

        let pastScore = pastPoints[p1] + pastPoints[p2] + pastPoints[p3];
        let horseRaw = body + time + pastScore;

        horses.push({
            body: body,
            time: time,
            jockeyRaw: jRaw,
            pastScore: pastScore,
            horseRaw: horseRaw
        });

        sumHorseRaw  += horseRaw;
        sumJockeyRaw += jRaw;
    }

    let totals = [];
    let maxTotal = 0;

    // 2回目ループ：正規化→馬70点＋騎手30点
    for (let i=1;i<=18;i++){
        let h = horses[i-1];

        let horseScore = 0;
        if(sumHorseRaw > 0 && h.horseRaw > 0){
            horseScore = (h.horseRaw / sumHorseRaw) * 70;
        }

        let jockeyScore = 0;
        if(sumJockeyRaw > 0 && h.jockeyRaw > 0){
            jockeyScore = (h.jockeyRaw / sumJockeyRaw) * 30;
        }

        let totalScore = horseScore + jockeyScore;

        document.getElementById(`pastTotal_${i}`).value =
            horseScore ? horseScore.toFixed(1) : "";
        document.getElementById(`jockeyP_${i}`).value =
            jockeyScore ? jockeyScore.toFixed(1) : "";
        document.getElementById(`total_${i}`).value =
            totalScore ? totalScore.toFixed(1) : "";

        totals.push({horse:i, total: totalScore});

        if(totalScore > maxTotal){
            maxTotal = totalScore;
        }
    }

    // 最高点表示（総合点の最大値）
    document.getElementById("avgScore").textContent = maxTotal.toFixed(1);

    // 順位表示
    totals.sort((a,b)=>b.total - a.total);
    let html = "";
    totals.forEach((t,idx)=>{
        html += `${idx+1}位：${t.horse}番（${t.total.toFixed(1)}）<br>`;
    });
    document.getElementById("rankList").innerHTML = html;

    saveData();
}

//------------------------------
// 現在の開催×レースのデータを保存
//------------------------------
function saveData(){
    if(!selectedKaisai || !selectedRace) return; // レース未選択時は保存しない

    let data = {
        date: document.getElementById("dateInput").value,
        kaisai: selectedKaisai,
        race: selectedRace,
        surface: document.getElementById("surface").value,
        distance: document.getElementById("distance").value,

        pace: Number(document.getElementById("pace").value),
        pickHorse: document.getElementById("pickHorse").value,
        buy: buyState,
        hit: hitState,
        oddsLow: document.getElementById("oddsLow").value,
        oddsHigh: document.getElementById("oddsHigh").value,
        memo: document.getElementById("memo").value,

        horses: []
    };

    for (let i=1;i<=18;i++){
        data.horses.push({
            body:   document.getElementById("body_"+i).value,
            time:   document.getElementById("time_"+i).value,
            jockey: document.getElementById("jockey_"+i).value,
            past1:  document.getElementById("past1_"+i).value,
            past2:  document.getElementById("past2_"+i).value,
            past3:  document.getElementById("past3_"+i).value
        });
    }

    localStorage.setItem(getStorageKey(), JSON.stringify(data));
}

//------------------------------
// 現在の開催×レースのデータを読み込み
//------------------------------
function loadDataForCurrentPair(){
    clearRaceFields();

    let raw = localStorage.getItem(getStorageKey());
    if(!raw){
        calcAll();
        return;
    }
    let data = JSON.parse(raw);

    if(data.date){
        document.getElementById("dateInput").value = data.date;
    }

    if(data.surface){
        document.getElementById("surface").value = data.surface;
    }
    if(data.distance){
        document.getElementById("distance").value = data.distance;
        document.getElementById("distanceLabel").textContent =
            `${data.distance}（${data.distance*100}m）`;
    }

    if(data.pace){ document.getElementById("pace").value = data.pace; }
    if(data.pickHorse){ document.getElementById("pickHorse").value = data.pickHorse; }

    buyState = data.buy || "";
    hitState = data.hit || "";
    applyToggle('buy', buyState);
    applyToggle('hit', hitState);

    document.getElementById("oddsLow").value  = data.oddsLow  || "";
    document.getElementById("oddsHigh").value = data.oddsHigh || "";
    document.getElementById("memo").value     = data.memo     || "";

    if(data.horses){
        for (let i=1;i<=18;i++){
            let h = data.horses[i-1] || {};
            document.getElementById(`body_${i}`).value   = h.body   || "";
            document.getElementById(`time_${i}`).value   = h.time   || "0";
            document.getElementById(`jockey_${i}`).value = h.jockey || "";
            document.getElementById(`past1_${i}`).value  = h.past1  || "0";
            document.getElementById(`past2_${i}`).value  = h.past2  || "0";
            document.getElementById(`past3_${i}`).value  = h.past3  || "0";
        }
    }

    calcAll();
}

//------------------------------
// 初期化（土曜版の全レースを削除）
//------------------------------
function resetData(){
    if(!confirm("土曜版の全レースのデータを削除します。よろしいですか？")) return;
    const keysToRemove = [];
    for(let i=0;i<localStorage.length;i++){
        const key = localStorage.key(i);
        if(key && key.startsWith(STORAGE_PREFIX + "_")){
            keysToRemove.push(key);
        }
    }
    keysToRemove.forEach(k => localStorage.removeItem(k));
    location.reload();
}

//------------------------------
// CSV出力（選択中の開催の全レース分）
//------------------------------
function csvEscape(v){
    if(v === null || v === undefined) return "";
    v = String(v).replace(/"/g,'""');
    if (/[",\n\r]/.test(v)) return `"${v}"`;
    return v;
}

function exportCSV(){
    if(!selectedKaisai){
        alert("開催を選択してください。");
        return;
    }

    // 選択中開催のキーを集める
    let keys = [];
    for(let i=0;i<localStorage.length;i++){
        const key = localStorage.key(i);
        if(key && key.startsWith(STORAGE_PREFIX + "_" + selectedKaisai + "_")){
            keys.push(key);
        }
    }
    if(keys.length === 0){
        alert("この開催のデータがありません。");
        return;
    }

    // レース番号順にソート
    keys.sort((a,b)=>{
        const ra = parseInt(a.split("_").pop(),10) || 0;
        const rb = parseInt(b.split("_").pop(),10) || 0;
        return ra - rb;
    });

    let rows = [];
    let header = [
        "日付","開催","レース番号","コース","距離m",
        "馬番","馬合計70","騎手点30","総合点100",
        "ペース予想","指名馬番","購入","的中",
        "複勝オッズ下","複勝オッズ上","メモ"
    ];
    rows.push(header.join(","));

    keys.forEach(key=>{
        let raw = localStorage.getItem(key);
        if(!raw) return;
        let data = JSON.parse(raw);

        let date    = data.date   || "";
        let kaisai  = data.kaisai || selectedKaisai;
        let race    = data.race   || parseInt(key.split("_").pop(),10) || "";
        let surface = data.surface|| "";
        let distVal = data.distance || "";
        let distM   = distVal ? distVal * 100 : "";

        let pace    = data.pace || "";
        let pick    = data.pickHorse || "";
        let buy     = data.buy || "";
        let hit     = data.hit || "";
        let oddsL   = data.oddsLow  || "";
        let oddsH   = data.oddsHigh || "";
        let memo    = data.memo     || "";

        let horses = data.horses || [];

        // 生スコア集計
        let temp = [];
        let sumHorseRaw = 0;
        let sumJockeyRaw = 0;

        for(let i=1;i<=18;i++){
            let h = horses[i-1] || {};
            let body = Number(h.body) || 0;
            let time = Number(h.time) || 0;
            let jRaw = Number(h.jockey) || 0;
            let p1   = Number(h.past1) || 0;
            let p2   = Number(h.past2) || 0;
            let p3   = Number(h.past3) || 0;

            let pastScore = pastPoints[p1] + pastPoints[p2] + pastPoints[p3];
            let horseRaw = body + time + pastScore;

            temp.push({
                horseNo: i,
                body: body,
                time: time,
                jRaw: jRaw,
                pastScore: pastScore,
                horseRaw: horseRaw
            });

            sumHorseRaw  += horseRaw;
            sumJockeyRaw += jRaw;
        }

        // 正規化＆CSV行作成
        temp.forEach(entry=>{
            const i = entry.horseNo;
            // 完全に空の馬はスキップ
            if(
                entry.body === 0 &&
                entry.time === 0 &&
                entry.jRaw === 0 &&
                entry.pastScore === 0
            ){
                return;
            }

            let horseScore = 0;
            if(sumHorseRaw > 0 && entry.horseRaw > 0){
                horseScore = (entry.horseRaw / sumHorseRaw) * 70;
            }

            let jockeyScore = 0;
            if(sumJockeyRaw > 0 && entry.jRaw > 0){
                jockeyScore = (entry.jRaw / sumJockeyRaw) * 30;
            }

            let totalScore = horseScore + jockeyScore;

            let row = [
                csvEscape(date),
                csvEscape(kaisai),
                csvEscape(race),
                csvEscape(surface),
                csvEscape(distM),

                csvEscape(i),
                csvEscape(horseScore ? horseScore.toFixed(1) : ""),
                csvEscape(jockeyScore ? jockeyScore.toFixed(1) : ""),
                csvEscape(totalScore ? totalScore.toFixed(1) : ""),

                csvEscape(pace),
                csvEscape(pick),
                csvEscape(buy),
                csvEscape(hit),
                csvEscape(oddsL),
                csvEscape(oddsH),
                csvEscape(memo)
            ];
            rows.push(row.join(","));
        });
    });

    let csvContent = rows.join("\r\n");
    let blob = new Blob([csvContent], {type:"text/csv;charset=utf-8;"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    let safeDate = document.getElementById("dateInput").value || "no-date";
    a.download = `keiba_saturday_${selectedKaisai}_${safeDate}.csv`;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
