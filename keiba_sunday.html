<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>競馬アプリ（日曜版・完成版）</title>
<style>
  body{
    font-family:Arial;
    margin:20px;
    background:#000;
    color:#fff;
  }
  h2{margin:0 0 10px 0}
  .top-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
  }
  .button-group button{
    padding:8px 14px;
    margin:3px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    background:#666;
    color:#fff;
    font-size:16px;
  }
  .button-group button.active{background:#3A74D8}
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
  }
  th,td{
    border:1px solid #555;
    padding:4px;
    text-align:center;
  }
  input,select{
    background:#444;
    color:#fff;
    border:1px solid #777;
    border-radius:4px;
  }
  input[readonly]{background:#222}
  .w1{width:45px}
  .w2{width:40px}
  .w3{width:70px}

  /* 点数系（馬合計・騎手点・総合点・ソフトマックス・オッズ）を細く */
  .score{
    width:55px;
  }

  .bottom-container{
    display:flex;
    margin-top:20px;
    gap:16px;
  }
  .rank-box{
    width:33%;
    border:1px solid #555;
    padding:8px;
  }
  .result-box{
    width:67%;
    border:1px solid #555;
    padding:8px;
  }
  .memo{
    width:100%;
    height:70px;
    background:#111;
    color:#fff;
  }
  .slider-container{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:10px;
  }
  .toggle-btn{
    padding:6px 12px;
    margin:4px;
    background:#666;
    color:#fff;
    border-radius:6px;
    border:none;
    cursor:pointer;
  }
  .toggle-btn.active{background:#3A74D8}
  .small-btn{
    padding:4px 10px;
    background:#777;
    color:#fff;
    border-radius:6px;
    border:none;
    cursor:pointer;
  }

  /* 馬体 ±1 ボタンのレイアウト */
  .body-box{
    display:flex;
    align-items:center;
    gap:2px;
    justify-content:center;
  }
  .adj-btn{
    width:24px;
    height:24px;
    background:#555;
    color:#fff;
    border:1px solid #777;
    border-radius:4px;
    font-size:14px;
    cursor:pointer;
    padding:0;
  }

</style>
</head>
<body>

<h2>競馬アプリ（日曜版・完成版）</h2>

<div class="top-row">
  <div>年月日：<input id="dateInput"></div>
  <div>
    <button onclick="exportCSV()">CSV出力</button>
    <button onclick="document.getElementById('csvFile').click()">CSV読込</button>
    <input type="file" id="csvFile" accept=".csv" style="display:none">
    <button onclick="resetData()">データ初期化</button>
  </div>
</div>

<div class="button-group" id="kaisaiButtons">
  <button onclick="selectKaisai(this,'東京')">東京</button>
  <button onclick="selectKaisai(this,'京都')">京都</button>
  <button onclick="selectKaisai(this,'中山')">中山</button>
  <button onclick="selectKaisai(this,'阪神')">阪神</button>
  <button onclick="selectKaisai(this,'その他')">その他</button>
</div>

<div class="button-group" id="raceButtons">
  <script>
    for(let i=1;i<=12;i++){
      document.write(`<button onclick="selectRace(this,${i})">${i}R</button>`);
    }
  </script>
</div>

<div class="slider-container">
  コース：
  <select id="surface" onchange="saveData()">
    <option>芝</option>
    <option>ダート</option>
  </select>
  距離：
  <button class="small-btn" onclick="changeDistance(-1)">－</button>
  <input type="range" min="10" max="36" value="24" id="distance" oninput="updateDistance();saveData()">
  <button class="small-btn" onclick="changeDistance(1)">＋</button>
  <span id="distanceLabel">24（2400m）</span>
  最高点：<span id="avgScore">0.0</span>
</div>

<table>
  <thead>
    <tr>
      <th>馬番</th>
      <th>馬体</th>
      <th>タイム</th>
      <th>騎手</th>
      <th>過去1</th>
      <th>過去2</th>
      <th>過去3</th>
      <th>馬合計</th>
      <th>騎手点</th>
      <th>総合点</th>
      <th>Softmax</th>
      <th>0.8倍オッズ</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<div class="bottom-container">
  <div class="rank-box">
    <h3>順位</h3>
    <div id="rankList"></div>
  </div>
  <div class="result-box">
    <h3>予想</h3>
    ペース
    <input type="range" min="1" max="5" value="3" id="pace" oninput="updatePaceLabel();saveData()">
    <span id="paceLabel">ミドル</span>
    <br>
    指名
    <select id="pickHorse" onchange="saveData()">
      <script>
        for(let i=1;i<=18;i++){
          document.write(`<option>${i}</option>`);
        }
      </script>
    </select>

    <h3>結果</h3>
    <button class="toggle-btn toggle-buy" data-value="yes" onclick="setToggle('buy','yes')">買う</button>
    <button class="toggle-btn toggle-buy" data-value="no" onclick="setToggle('buy','no')">買わない</button><br>
    <button class="toggle-btn toggle-hit" data-value="yes" onclick="setToggle('hit','yes')">的中</button>
    <button class="toggle-btn toggle-hit" data-value="no" onclick="setToggle('hit','no')">不的中</button><br>
    オッズ<input id="oddsLow">〜<input id="oddsHigh"><br>
    <textarea class="memo" id="memo" oninput="saveData()"></textarea>
  </div>
</div>

<script>
  const STORAGE_PREFIX = "keiba_app_sunday";
  const pastPoints = {0:0,1:10,2:8,3:6,4:3};

  let selectedKaisai = "";
  let selectedRace = 0;
  let buyState = "";
  let hitState = "";

  // 行の生成
  const tbody = document.getElementById("tbody");
  for(let i=1;i<=18;i++){
    tbody.innerHTML += `
      <tr>
        <td>${i}</td>
        <td>
          <div class="body-box">
            <input id="body_${i}" class="w2" oninput="calcAll()" onkeydown="focusNextBody(event,${i})">
            <button type="button" class="adj-btn" onclick="changeBody(${i},1)">＋</button>
            <button type="button" class="adj-btn" onclick="changeBody(${i},-1)">－</button>
          </div>
        </td>
        <td>
          <select id="time_${i}" class="w1" onchange="calcAll()">
            <option value="0"></option>
            <option>8</option>
            <option>4</option>
            <option>2</option>
            <option>1</option>
          </select>
        </td>
        <td>
          <input id="jockey_${i}" class="w3" oninput="calcAll()" onkeydown="focusNextJockey(event,${i})">
        </td>
        <td>
          <select id="past1_${i}" onchange="calcAll()">
            <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </td>
        <td>
          <select id="past2_${i}" onchange="calcAll()">
            <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </td>
        <td>
          <select id="past3_${i}" onchange="calcAll()">
            <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </td>
        <td><input id="pastTotal_${i}" class="score" readonly></td>
        <td><input id="jockeyP_${i}" class="score" readonly></td>
        <td><input id="total_${i}" class="score" readonly></td>
        <td><input id="softmax_${i}" class="score" readonly></td>
        <td><input id="odds08_${i}" class="score" readonly></td>
      </tr>
    `;
  }

  // 馬体 Enter で次の馬体へ
  function focusNextBody(e, i){
    if(e.key === "Enter"){
      e.preventDefault();
      const next = document.getElementById("body_"+(i+1));
      if(next) next.focus();
    }
  }

  // 騎手 Enter で次の騎手へ
  function focusNextJockey(e, i){
    if(e.key === "Enter"){
      e.preventDefault();
      const next = document.getElementById("jockey_"+(i+1));
      if(next) next.focus();
    }
  }

  // 馬体 ±1
  function changeBody(i, delta){
    const el = document.getElementById("body_"+i);
    const v = parseInt(el.value || "0", 10);
    el.value = v + delta;
    calcAll();
  }

  function selectKaisai(btn, name){
    document.querySelectorAll("#kaisaiButtons button").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    selectedKaisai = name;
    loadData();
  }

  function selectRace(btn, num){
    document.querySelectorAll("#raceButtons button").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    selectedRace = num;
    loadData();
  }

  function updateDistance(){
    const v = distance.value;
    distanceLabel.textContent = `${v}（${v*100}m）`;
  }

  function changeDistance(d){
    let v = parseInt(distance.value) + d;
    if(v < 10) v = 10;
    if(v > 36) v = 36;
    distance.value = v;
    updateDistance();
    saveData();
  }

  function getKey(){
    return STORAGE_PREFIX + "_" + selectedKaisai + "_" + selectedRace;
  }

  function setToggle(group, value){
    document.querySelectorAll(".toggle-"+group).forEach(b=>{
      b.classList.toggle("active", b.dataset.value === value);
    });
    if(group === "buy") buyState = value;
    if(group === "hit") hitState = value;
    saveData();
  }

  // pace のラベル文字列
  function getPaceLabel(value){
    switch(Number(value)){
      case 1: return "スロー";
      case 2: return "mスロー";
      case 3: return "ミドル";
      case 4: return "mハイ";
      case 5: return "ハイ";
      default: return "";
    }
  }

  function updatePaceLabel(){
    const p = document.getElementById("pace");
    const label = document.getElementById("paceLabel");
    if(p && label){
      label.textContent = getPaceLabel(p.value);
    }
  }

  function body_i(i){return document.getElementById("body_"+i).value || 0}
  function time_i(i){return document.getElementById("time_"+i).value || 0}
  function jockey_i(i){return document.getElementById("jockey_"+i).value || 0}
  function past1_i(i){return document.getElementById("past1_"+i).value}
  function past2_i(i){return document.getElementById("past2_"+i).value}
  function past3_i(i){return document.getElementById("past3_"+i).value}
  function past(i){
    return pastPoints[past1_i(i)] + pastPoints[past2_i(i)] + pastPoints[past3_i(i)];
  }

  function umaTotal_i(i){
    return document.getElementById("pastTotal_"+i).value || 0;
  }
  function kisyuPoint_i(i){
    return document.getElementById("jockeyP_"+i).value || 0;
  }
  function total_i(i){
    return document.getElementById("total_"+i).value || 0;
  }

  // 得点計算 ＋ ランキング ＋ Softmax & 0.8倍オッズ
  function calcAll(){
    let sumH = 0;
    let sumJ = 0;
    const temp = [];

    for(let i=1;i<=18;i++){
      const b = +body_i(i);
      const t = +time_i(i);
      const j = +jockey_i(i);
      const p = past(i);
      const raw = b + t + p;

      temp.push({raw, j});
      sumH += raw;
      sumJ += j;
    }

    let max = 0;
    const res = [];

    temp.forEach((h, idx)=>{
      const i = idx + 1;
      const hs = sumH ? h.raw / sumH * 70 : 0;
      const js = sumJ ? h.j   / sumJ * 30 : 0;
      const tot = hs + js;

      document.getElementById("pastTotal_"+i).value = hs ? hs.toFixed(1) : "";
      document.getElementById("jockeyP_"+i).value   = js ? js.toFixed(1) : "";
      document.getElementById("total_"+i).value     = tot ? tot.toFixed(1) : "";

      res.push({n:i, v:tot});
      if(tot > max) max = tot;
    });

    avgScore.textContent = max.toFixed(1);

    rankList.innerHTML = res
      .filter(r=>r.v>0)
      .sort((a,b)=>b.v - a.v)
      .map((r,i)=>`${i+1}位 ${r.n}番`)
      .join("<br>");

    calcSoftmaxOdds();
    saveData();
  }

  // Softmax と 0.8倍オッズ計算
  function calcSoftmaxOdds(){
    const active = [];

    for(let i=1;i<=18;i++){
      const v = parseFloat(document.getElementById("total_"+i).value);
      if(!isNaN(v) && v > 0){
        active.push({index:i, value:v});
      }
    }

    // 出走馬なし
    if(active.length === 0){
      for(let i=1;i<=18;i++){
        document.getElementById("softmax_"+i).value = "";
        document.getElementById("odds08_"+i).value = "";
      }
      return;
    }

    const values = active.map(a=>a.value);
    const maxVal = Math.max(...values);
    const exps = values.map(v=>Math.exp(v - maxVal));
    const sumExp = exps.reduce((a,b)=>a+b,0);

    // まず全て空に
    for(let i=1;i<=18;i++){
      document.getElementById("softmax_"+i).value = "";
      document.getElementById("odds08_"+i).value = "";
    }

    active.forEach((a, idx)=>{
      const p = exps[idx] / sumExp;   // softmax確率
      const odds = (1 / p) * 0.8;     // 0.8倍オッズ

      document.getElementById("softmax_"+a.index).value = p.toFixed(3);
      document.getElementById("odds08_"+a.index).value  = odds.toFixed(2);
    });
  }

  function saveData(){
    if(!selectedKaisai || !selectedRace) return;

    const d = {
      date      : dateInput.value,
      kaisai    : selectedKaisai,
      race      : selectedRace,
      surface   : surface.value,
      distance  : distance.value,
      pace      : pace.value,
      pickHorse : pickHorse.value,
      buy       : buyState,
      hit       : hitState,
      oddsLow   : oddsLow.value,
      oddsHigh  : oddsHigh.value,
      memo      : memo.value,
      horses    : []
    };

    for(let i=1;i<=18;i++){
      d.horses.push({
        body      : body_i(i),
        time      : time_i(i),
        jockey    : jockey_i(i),
        past1     : past1_i(i),
        past2     : past2_i(i),
        past3     : past3_i(i),
        umaTotal  : umaTotal_i(i),
        kisyuPoint: kisyuPoint_i(i),
        total     : total_i(i)
      });
    }

    localStorage.setItem(getKey(), JSON.stringify(d));
  }

  function loadData(){

    // まず画面をクリア
    dateInput.value = "";
    surface.value = "芝";
    distance.value = 24;
    updateDistance();
    pace.value = 3;
    updatePaceLabel();
    pickHorse.value = 1;
    oddsLow.value = "";
    oddsHigh.value = "";
    memo.value = "";
    buyState = "";
    hitState = "";
    document.querySelectorAll(".toggle-buy,.toggle-hit").forEach(b=>b.classList.remove("active"));

    for(let i=1;i<=18;i++){
      document.getElementById("body_"+i).value = "";
      document.getElementById("time_"+i).value = 0;
      document.getElementById("jockey_"+i).value = "";
      document.getElementById("past1_"+i).value = 0;
      document.getElementById("past2_"+i).value = 0;
      document.getElementById("past3_"+i).value = 0;
      document.getElementById("pastTotal_"+i).value = "";
      document.getElementById("jockeyP_"+i).value = "";
      document.getElementById("total_"+i).value = "";
      document.getElementById("softmax_"+i).value = "";
      document.getElementById("odds08_"+i).value = "";
    }

    rankList.innerHTML = "";
    avgScore.textContent = "0.0";

    const raw = localStorage.getItem(getKey());
    if(!raw){
      calcSoftmaxOdds();
      return;
    }

    const d = JSON.parse(raw);

    dateInput.value   = d.date      || "";
    surface.value     = d.surface   || "芝";
    distance.value    = d.distance  || 24;
    updateDistance();
    pace.value        = d.pace      || 3;
    updatePaceLabel();
    pickHorse.value   = d.pickHorse || 1;
    oddsLow.value     = d.oddsLow   || "";
    oddsHigh.value    = d.oddsHigh  || "";
    memo.value        = d.memo      || "";

    buyState = d.buy || "";
    hitState = d.hit || "";

    if(buyState) setToggle("buy", buyState);
    if(hitState) setToggle("hit", hitState);

    (d.horses || []).forEach((h, idx)=>{
      const n = idx + 1;
      document.getElementById("body_"+n).value    = h.body   || "";
      document.getElementById("time_"+n).value    = h.time   || 0;
      document.getElementById("jockey_"+n).value  = h.jockey || "";
      document.getElementById("past1_"+n).value   = h.past1  || 0;
      document.getElementById("past2_"+n).value   = h.past2  || 0;
      document.getElementById("past3_"+n).value   = h.past3  || 0;
    });

    calcAll();
  }

  function resetData(){
    if(confirm("全削除しますか？")){
      Object.keys(localStorage)
        .filter(k=>k.startsWith(STORAGE_PREFIX))
        .forEach(k=>localStorage.removeItem(k));
      location.reload();
    }
  }

  function csvEscape(v){
    if(v===null || v===undefined) return "";
    v = String(v).replace(/"/g,'""');
    return /[",\n]/.test(v) ? `"${v}"` : v;
  }

  function exportCSV(){
    if(!selectedKaisai){
      alert("開催を選択してください");
      return;
    }

    const date  = dateInput.value || "no-date";
    const place = selectedKaisai;

    const rows = [];
    const header = [
      "日付","開催","レース番号","コース","距離m",
      "馬番","馬体","タイム","騎手",
      "過去1","過去2","過去3",
      "馬合計70","騎手点30","総合点100",
      "ペース予想","指名馬番","購入","的中",
      "複勝オッズ下","複勝オッズ上","メモ"
    ];
    rows.push(header.join(","));

    // 12R ループ
    for(let r=1;r<=12;r++){
      const key = `${STORAGE_PREFIX}_${place}_${r}`;
      const data = JSON.parse(localStorage.getItem(key) || "null");
      if(!data || !data.horses) continue;

      for(let i=1;i<=18;i++){
        const h = data.horses[i-1] || {};
        const row = [
          csvEscape(data.date),
          csvEscape(data.kaisai),
          csvEscape(data.race),
          csvEscape(data.surface),
          csvEscape(data.distance*100),
          csvEscape(i),
          csvEscape(h.body),
          csvEscape(h.time),
          csvEscape(h.jockey),
          csvEscape(h.past1),
          csvEscape(h.past2),
          csvEscape(h.past3),
          csvEscape(h.umaTotal || ""),
          csvEscape(h.kisyuPoint || ""),
          csvEscape(h.total || ""),
          csvEscape(data.pace),
          csvEscape(data.pickHorse),
          csvEscape(data.buy),
          csvEscape(data.hit),
          csvEscape(data.oddsLow),
          csvEscape(data.oddsHigh),
          csvEscape(data.memo)
        ];
        rows.push(row.join(","));
      }
    }

    if(rows.length === 1){
      alert("この開催に保存データがありません");
      return;
    }

    const csvContent = rows.join("\r\n");
    const blob = new Blob([csvContent], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.download = `keiba_saturday_${date}_${place}_ALL.csv`;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ==============================
  // CSV 読み込み（完全復元）
  // ==============================
  document.getElementById("csvFile").addEventListener("change",e=>{
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      importCSV(ev.target.result);
    };
    reader.readAsText(file,"utf-8");
  });

  function importCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const headers = lines[0].split(",");
    const rows = lines.slice(1).map(l=>l.split(","));

    const idx = name => headers.indexOf(name);

    const map = {
      date : idx("日付"),
      place: idx("開催"),
      race : idx("レース番号"),
      course:idx("コース"),
      dist : idx("距離m"),
      horse: idx("馬番"),
      body : idx("馬体"),
      time : idx("タイム"),
      jockey:idx("騎手"),
      p1   : idx("過去1"),
      p2   : idx("過去2"),
      p3   : idx("過去3"),
      uma  : idx("馬合計70"),
      kisyu: idx("騎手点30"),
      total: idx("総合点100"),
      pace : idx("ペース予想"),
      pick : idx("指名馬番"),
      buy  : idx("購入"),
      hit  : idx("的中"),
      oddsL: idx("複勝オッズ下"),
      oddsH: idx("複勝オッズ上"),
      memo : idx("メモ")
    };

    rows.forEach(r=>{
      const race = Number(r[map.race]);
      if(!race || race<1 || race>12) return;

      const place = r[map.place];
      const key = `${STORAGE_PREFIX}_${place}_${race}`;

      const baseJson = `{
        "date":"", "kaisai":"${place}", "race":${race},
        "surface":"芝", "distance":24, "pace":3,
        "pickHorse":1, "buy":"", "hit":"",
        "oddsLow":"", "oddsHigh":"", "memo":"",
        "horses":[]
      }`;

      const data = JSON.parse(localStorage.getItem(key) || baseJson);

      const i = Number(r[map.horse]) - 1;

      data.date      = r[map.date];
      data.surface   = r[map.course];
      data.distance  = Number(r[map.dist]) / 100;
      data.pace      = r[map.pace];
      data.pickHorse = r[map.pick];
      data.buy       = r[map.buy];
      data.hit       = r[map.hit];
      data.oddsLow   = r[map.oddsL];
      data.oddsHigh  = r[map.oddsH];
      data.memo      = r[map.memo];

      if(!data.horses[i]) data.horses[i] = {};

      data.horses[i] = {
        body      : r[map.body],
        time      : r[map.time],
        jockey    : r[map.jockey],
        past1     : r[map.p1],
        past2     : r[map.p2],
        past3     : r[map.p3],
        umaTotal  : r[map.uma],
        kisyuPoint: r[map.kisyu],
        total     : r[map.total]
      };

      localStorage.setItem(key, JSON.stringify(data));
    });

    alert("開催データを一括復元しました");
  }

  // 初期表示用
  updateDistance();
  updatePaceLabel();

</script>

</body>
</html>
