<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç«¶é¦¬ã‚¢ãƒ—ãƒªï¼ˆæ—¥æ›œç‰ˆãƒ»å®Œæˆç‰ˆï¼‰</title>
<style>
  body{font-family:Arial;margin:20px;background:#000;color:#fff}
  h2{margin:0 0 10px 0}
  .top-row{
    display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;
    gap:10px;flex-wrap:wrap;
  }
  .button-group button{
    padding:8px 14px;margin:3px;border:none;border-radius:6px;cursor:pointer;
    background:#666;color:#fff;font-size:16px;
  }
  .button-group button.active{background:#3A74D8}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #555;padding:4px;text-align:center}
  input,select,textarea{
    background:#444;color:#fff;border:1px solid #777;border-radius:4px;
  }
  input[readonly]{background:#222}
  .w1{width:50px}
  .w2{width:48px}
  .w3{width:90px}
  .score{width:62px}
  .mini-input{width:70px}
  .bottom-container{display:flex;margin-top:20px;gap:16px;flex-wrap:wrap}
  .rank-box{width:33%;border:1px solid #555;padding:8px;min-width:280px}
  .result-box{width:67%;border:1px solid #555;padding:8px;min-width:320px;flex:1}
  .memo{width:100%;height:70px;background:#111;color:#fff}
  .slider-container{
    display:flex;align-items:center;gap:12px;margin-bottom:10px;flex-wrap:wrap
  }
  .toggle-btn{
    padding:6px 12px;margin:4px;background:#666;color:#fff;border-radius:6px;border:none;cursor:pointer;
  }
  .toggle-btn.active{background:#3A74D8}
  .small-btn{
    padding:4px 10px;background:#777;color:#fff;border-radius:6px;border:none;cursor:pointer;
  }

  /* é¦¬ä½“ Â± ãƒœã‚¿ãƒ³ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .body-box{display:flex;align-items:center;gap:2px;justify-content:center}
  .adj-btn{
    width:26px;height:26px;background:#555;color:#fff;border:1px solid #777;border-radius:4px;
    font-size:14px;cursor:pointer;padding:0;
  }

  /* å›é¿è¡¨ç¤ºãƒãƒƒãƒ— */
  .chip{
    display:inline-block;padding:2px 8px;border-radius:999px;font-size:14px;border:1px solid #555;
    margin-left:6px;vertical-align:middle;white-space:nowrap;
  }
  .chip-warn{ color:#ffd54a; border-color:#8a7a2a; }
  .chip-stop{ color:#ff6b6b; border-color:#8a2a2a; }

  .result-row{display:flex;align-items:center;flex-wrap:wrap;gap:10px;margin-top:6px}

  /* æ è¡¨ç¤ºï¼ˆè‰²ã®ä¸­ã«ç•ªå·ï¼‰ */
  .waku-badge{
    width:22px;height:22px;border-radius:6px;display:inline-flex;
    align-items:center;justify-content:center;font-weight:700;border:1px solid #999;
    user-select:none;
  }

  /* éå‡ºèµ°è¡Œ */
  tr.inactive td{opacity:0.45}

  /* ä¸€æ‹¬è²¼ä»˜ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,0.72);
    display:none;align-items:center;justify-content:center;padding:16px;
    z-index:9999;
  }
  .modal{
    width:min(720px, 96vw);
    border:1px solid #555;border-radius:12px;background:#0b0b0b;
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
    padding:14px;
  }
  .modal h3{margin:0 0 8px 0}
  .modal .desc{color:#cfcfcf;font-size:13px;margin:0 0 8px 0;line-height:1.4}
  .modal textarea{
    width:100%;height:180px;background:#111;color:#fff;border:1px solid #666;border-radius:10px;
    padding:10px;box-sizing:border-box;
  }
  .modal .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .modal .row .small{font-size:12px;color:#cfcfcf}
</style>
</head>

<body>
<h2>ç«¶é¦¬ã‚¢ãƒ—ãƒªï¼ˆæ—¥æ›œç‰ˆãƒ»å®Œæˆç‰ˆï¼‰</h2>

<div class="top-row">
  <div>
    å¹´æœˆæ—¥ï¼š<input id="dateInput">
    <label style="margin-left:10px; user-select:none;">
      <input type="checkbox" id="skipRace" onchange="saveData()"> ä¸å‚åŠ 
    </label>
  </div>
  <div>
    <button onclick="exportCSV()">CSVå‡ºåŠ›</button>
    <button onclick="document.getElementById('csvFile').click()">CSVèª­è¾¼</button>
    <input type="file" id="csvFile" accept=".csv" style="display:none">
    <button onclick="resetData()">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
  </div>
</div>

<div class="button-group" id="kaisaiButtons">
  <button onclick="selectKaisai(this,'æ±äº¬')">æ±äº¬</button>
  <button onclick="selectKaisai(this,'äº¬éƒ½')">äº¬éƒ½</button>
  <button onclick="selectKaisai(this,'ä¸­å±±')">ä¸­å±±</button>
  <button onclick="selectKaisai(this,'é˜ªç¥')">é˜ªç¥</button>
  <button onclick="selectKaisai(this,'ãã®ä»–')">ãã®ä»–</button>
</div>

<div class="button-group" id="raceButtons">
  <script>
    for(let i=1;i<=12;i++){
      document.write(`<button onclick="selectRace(this,${i})">${i}R</button>`);
    }
  </script>
</div>

<div class="slider-container">
  é ­æ•°ï¼š
  <button class="small-btn" onclick="changeField('runners',-1)">ï¼</button>
  <input id="runners" class="mini-input" value="12" inputmode="numeric" oninput="onRunnersChanged()">
  <button class="small-btn" onclick="changeField('runners',1)">ï¼‹</button>

  ã‚³ãƒ¼ã‚¹ï¼š
  <select id="surface" onchange="calcAll();saveData()">
    <option>èŠ</option>
    <option>ãƒ€ãƒ¼ãƒˆ</option>
  </select>

  è·é›¢ï¼š
  <button class="small-btn" onclick="changeDistance(-1)">ï¼</button>
  <input type="range" min="10" max="36" value="20" id="distance" oninput="updateDistance();calcAll();saveData()">
  <button class="small-btn" onclick="changeDistance(1)">ï¼‹</button>
  <span id="distanceLabel">20ï¼ˆ2000mï¼‰</span>

  ä¸Šä½3ä½ï¼š<span id="avgScore">-</span>

  <button class="small-btn" onclick="openBatchModal('jockey')">é¨æ‰‹ä¸€æ‹¬è²¼ä»˜</button>
  <button class="small-btn" onclick="openBatchModal('jisseki')">å®Ÿç¸¾ä¸€æ‹¬è²¼ä»˜</button>
  <button class="small-btn" onclick="copyTotals()">ç·åˆç‚¹ã‚³ãƒ”ãƒ¼</button>
</div>

<table>
  <thead>
    <tr>
      <th>æ </th>
      <th>é¦¬ç•ª</th>
      <th>è„šè‰²</th>
      <th>é¦¬ä½“</th>
      <th>ã‚¿ã‚¤ãƒ </th>
      <th>
        <button class="small-btn" style="padding:2px 8px" onclick="openBatchModal('jockey')">é¨æ‰‹(è¤‡å‹ç‡)</button>
      </th>
      <th>
        <button class="small-btn" style="padding:2px 8px" onclick="openBatchModal('jisseki')">å®Ÿç¸¾(ãƒã‚¤ãƒ³ãƒˆ)</button>
      </th>
      <th>é¦¬åˆè¨ˆ</th>
      <th>é¨æ‰‹ç‚¹</th>
      <th>ç·åˆç‚¹</th>
      <th>Softmax</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<div class="bottom-container">
  <div class="rank-box">
    <h3>é †ä½</h3>
    <div id="rankList"></div>
  </div>

  <div class="result-box">
    <h3 style="margin-bottom:6px;">
      äºˆæƒ³
      <span id="avoidLabel"></span>
    </h3>

    <div class="result-row">
      ãƒšãƒ¼ã‚¹
      <input type="range" min="1" max="5" value="3" id="pace" oninput="updatePaceLabel();calcAll();saveData()">
      <span id="paceLabel">ãƒŸãƒ‰ãƒ«</span>

      æŒ‡å
      <select id="pickHorse" onchange="saveData()">
        <script>
          for(let i=1;i<=18;i++){
            document.write(`<option>${i}</option>`);
          }
        </script>
      </select>
    </div>

    <h3 style="margin-top:12px; margin-bottom:6px;">çµæœ</h3>

    <div class="result-row">
      <button class="toggle-btn toggle-buy" data-value="yes" onclick="setToggle('buy','yes')">è²·ã†</button>
      <button class="toggle-btn toggle-buy" data-value="no"  onclick="setToggle('buy','no')">è²·ã‚ãªã„</button>

      <button class="toggle-btn toggle-hit" data-value="yes" onclick="setToggle('hit','yes')">çš„ä¸­</button>
      <button class="toggle-btn toggle-hit" data-value="no"  onclick="setToggle('hit','no')">ä¸çš„ä¸­</button>

      é…å½“ <input id="payout" class="mini-input" value="0" inputmode="decimal" oninput="saveData()">
    </div>

    <div class="result-row">
      1ç€ <input id="fin1" class="mini-input" inputmode="numeric" oninput="saveData()">
      2ç€ <input id="fin2" class="mini-input" inputmode="numeric" oninput="saveData()">
      3ç€ <input id="fin3" class="mini-input" inputmode="numeric" oninput="saveData()">
    </div>

    <div class="result-row">
      ã‚ªãƒƒã‚º <input id="oddsLow" class="mini-input" inputmode="decimal" oninput="saveData()"> ã€œ
      <input id="oddsHigh" class="mini-input" inputmode="decimal" oninput="saveData()">
    </div>

    <textarea class="memo" id="memo" oninput="saveData()"></textarea>
  </div>
</div>

<!-- ä¸€æ‹¬è²¼ä»˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modalBackdrop" class="modal-backdrop" onclick="closeModalIfBackdrop(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="modalTitle">ä¸€æ‹¬è²¼ä»˜</h3>
    <p id="modalDesc" class="desc"></p>
    <textarea id="modalText" placeholder=""></textarea>
    <div class="row">
      <button class="small-btn" onclick="applyBatch()">åæ˜ </button>
      <button class="small-btn" onclick="closeBatchModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <span id="modalHint" class="small"></span>
    </div>
  </div>
</div>

<script>
  // ============================
  // ä¿å­˜ã‚­ãƒ¼ï¼ˆåœŸæ›œç‰ˆï¼‰
  // ============================
  const STORAGE_PREFIX = "keiba_app_sunday";

  // é…åˆ†ï¼ˆé¦¬80ï¼šé¨æ‰‹20ï¼‰
  const WEIGHT = { HORSE: 80, JOCKEY: 20 };

  // åˆ¤å®šé–¾å€¤ï¼ˆå›é¿ã‚µã‚¤ãƒ³ï¼‰
  const THRESH = {
    UMA_MIN: 14.0,
    GAP_DANGO: 1.5,
    JOCKEY_RATIO_MAX: 0.25
  };

  // ============================
  // æ è‰²ï¼ˆè¡¨ç¤ºç”¨ï¼‰
  // ============================
  const WAKU_COLORS = {
    1:{name:"ç™½", css:"#ffffff"},
    2:{name:"é»’", css:"#2b2b2b"},
    3:{name:"èµ¤", css:"#d84a4a"},
    4:{name:"é’", css:"#3a74d8"},
    5:{name:"é»„", css:"#f2d84a"},
    6:{name:"ç·‘", css:"#4ad86a"},
    7:{name:"æ©™", css:"#ff9a3a"},
    8:{name:"æ¡ƒ", css:"#ff7fb0"},
  };

  function textColorForBg(hex){
    const c = hex.replace("#","");
    const r = parseInt(c.slice(0,2),16);
    const g = parseInt(c.slice(2,4),16);
    const b = parseInt(c.slice(4,6),16);
    const y = (r*299 + g*587 + b*114)/1000;
    return (y < 140) ? "#fff" : "#000";
  }

  // ============================
  // æ ãƒ»è„šè‰²è£œæ­£ï¼ˆrawã«å°ã•ãè¶³ã™ï¼‰
  // ============================
  const BIAS = {
    IN_STRONG: [ 1.2, 0.9, 0.6, 0.3, 0.0,-0.3,-0.6,-0.9],
    IN_MID:    [ 0.9, 0.6, 0.4, 0.2, 0.0,-0.2,-0.4,-0.6],
    NEUTRAL:   [ 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
    OUT_MID:   [-0.3,-0.2, 0.0, 0.1, 0.2, 0.3, 0.2, 0.1],
  };

  const STYLE = {
    "":     [ 0,0,0,0,0,0,0,0 ],
    "é€ƒã’": [ 0.3, 0.2, 0.1, 0.0, 0.0,-0.1,-0.2,-0.3],
    "å…ˆè¡Œ": [ 0.2, 0.15,0.1, 0.0, 0.0,-0.1,-0.15,-0.2],
    "ä¸­æ®µ": [ 0.0, 0.05,0.1, 0.15,0.15,0.1, 0.05,0.0],
    "å·®ã—": [-0.1,0.0, 0.05,0.15,0.2, 0.25,0.2, 0.15],
    "è¿½è¾¼": [-0.1,0.0, 0.05,0.15,0.2, 0.3, 0.25,0.15],
  };

  const BIAS_K = 1.0;

  const COURSE_DICT = {
    "ä¸­å±±": {
      "èŠ": {
        "1200": { baseBias:"IN_MID" },
        "1600": { baseBias:"IN_MID" },
        "1800": { baseBias:"IN_STRONG" },
        "2000": { baseBias:"IN_STRONG" },
        "2200": { baseBias:"IN_MID" },
        "2500": { baseBias:"IN_STRONG" },
        "2600": { baseBias:"IN_MID" },
        "3200": { baseBias:"NEUTRAL" },
        "3600": { baseBias:"IN_MID" },
        "4000": { baseBias:"NEUTRAL" },
      },
      "ãƒ€ãƒ¼ãƒˆ": {
        "1200": { baseBias:"IN_MID" },
        "1800": { baseBias:"IN_MID" },
      },
    },
    "æ±äº¬": {
      "èŠ": {
        "1400": { baseBias:"IN_MID" },
        "1600": { baseBias:"NEUTRAL" },
        "1800": { baseBias:"IN_MID" },
        "2000": { baseBias:"IN_MID" },
        "2400": { baseBias:"NEUTRAL" },
        "2500": { baseBias:"NEUTRAL" },
        "3400": { baseBias:"NEUTRAL" },
      },
      "ãƒ€ãƒ¼ãƒˆ": {
        "1400": { baseBias:"IN_MID" },
        "1600": { baseBias:"IN_MID" },
        "2100": { baseBias:"NEUTRAL" },
      },
    },
    "äº¬éƒ½": {
      "èŠ": {
        "1200": { baseBias:"IN_MID" },
        "1400": { baseBias:"IN_MID" },
        "1600": { baseBias:"NEUTRAL" },
        "1800": { baseBias:"NEUTRAL" },
        "2000": { baseBias:"NEUTRAL" },
        "2400": { baseBias:"NEUTRAL" },
        "3000": { baseBias:"NEUTRAL" },
        "3200": { baseBias:"NEUTRAL" },
      },
      "ãƒ€ãƒ¼ãƒˆ": {
        "1200": { baseBias:"IN_MID" },
        "1800": { baseBias:"IN_MID" },
      },
    },
    "é˜ªç¥": {
      "èŠ": {
        "1200": { baseBias:"IN_MID" },
        "1400": { baseBias:"IN_MID" },
        "1600": { baseBias:"NEUTRAL" },
        "1800": { baseBias:"NEUTRAL" },
        "2000": { baseBias:"IN_MID" },
        "2200": { baseBias:"IN_MID" },
        "2400": { baseBias:"NEUTRAL" },
        "3000": { baseBias:"NEUTRAL" },
        "3200": { baseBias:"NEUTRAL" },
      },
      "ãƒ€ãƒ¼ãƒˆ": {
        "1200": { baseBias:"IN_MID" },
        "1400": { baseBias:"IN_MID" },
        "1800": { baseBias:"IN_MID" },
      },
    },
  };

  function paceStyleMultiplier(style, paceValue){
    const p = Number(paceValue);
    const isSlow = (p<=2);
    const isHigh = (p>=4);
    if(isSlow && (style==="é€ƒã’" || style==="å…ˆè¡Œ" || style==="ä¸­æ®µ")) return 1.2;
    if(isHigh && (style==="å·®ã—" || style==="è¿½è¾¼" || style==="ä¸­æ®µ")) return 1.2;
    return 1.0;
  }

  // ============================
  // æ—§ãƒ‡ãƒ¼ã‚¿å¤‰æ›ç”¨ï¼ˆéå»1ã€œ3 â†’ å®Ÿç¸¾ãƒã‚¤ãƒ³ãƒˆï¼‰
  // ============================
  const pastPointsLegacy = {0:0,1:10,2:8,3:6,4:3};
  function legacyPastSum(p1,p2,p3){
    const a = pastPointsLegacy[Number(p1)||0] || 0;
    const b = pastPointsLegacy[Number(p2)||0] || 0;
    const c = pastPointsLegacy[Number(p3)||0] || 0;
    return a+b+c;
  }

  let selectedKaisai = "";
  let selectedRace = 0;
  let buyState = "";
  let hitState = "";

  // ============================
  // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œç”Ÿæˆ
  // ============================
  const tbody = document.getElementById("tbody");
  for(let i=1;i<=18;i++){
    tbody.innerHTML += `
      <tr id="row_${i}">
        <td><span id="waku_${i}"></span></td>
        <td>${i}</td>

        <td>
          <select id="style_${i}" onchange="calcAll();saveData()">
            <option value=""></option>
            <option>é€ƒã’</option>
            <option>å…ˆè¡Œ</option>
            <option>ä¸­æ®µ</option>
            <option>å·®ã—</option>
            <option>è¿½è¾¼</option>
          </select>
        </td>

        <td>
          <div class="body-box">
            <input id="body_${i}" class="w2" oninput="calcAll()" onkeydown="focusNextBody(event,${i})">
            <button type="button" class="adj-btn" onclick="changeBody(${i}, 5)">ï¼‹</button>
            <button type="button" class="adj-btn" onclick="changeBody(${i},-5)">ï¼</button>
          </div>
        </td>

        <td>
          <select id="time_${i}" class="w1" onchange="calcAll()">
            <option value="0"></option>
            <option>8</option>
            <option>4</option>
            <option>2</option>
            <option>1</option>
          </select>
        </td>

        <td>
          <input id="jockey_${i}" class="w3" inputmode="decimal" oninput="calcAll()" onkeydown="focusNextJockey(event,${i})" placeholder="ä¾‹ 0.23">
        </td>

        <td>
          <input id="jisseki_${i}" class="w2" inputmode="numeric" oninput="calcAll()" onkeydown="focusNextJisseki(event,${i})" placeholder="">
        </td>

        <td><input id="pastTotal_${i}" class="score" readonly></td>
        <td><input id="jockeyP_${i}" class="score" readonly></td>
        <td><input id="total_${i}" class="score" readonly></td>
        <td><input id="softmax_${i}" class="score" readonly></td>
      </tr>
    `;
  }

  // ============================
  // å…¥åŠ›ç§»å‹•
  // ============================
  function focusNextBody(e, i){
    if(e.key === "Enter"){
      e.preventDefault();
      const next = document.getElementById("body_"+(i+1));
      if(next) next.focus();
    }
  }
  function focusNextJockey(e, i){
    if(e.key === "Enter"){
      e.preventDefault();
      const next = document.getElementById("jockey_"+(i+1));
      if(next) next.focus();
    }
  }
  function focusNextJisseki(e, i){
    if(e.key === "Enter"){
      e.preventDefault();
      const next = document.getElementById("jisseki_"+(i+1));
      if(next) next.focus();
    }
  }

  // é¦¬ä½“ Â±ï¼ˆ5åˆ»ã¿ï¼‰
  function changeBody(i, delta){
    const el = document.getElementById("body_"+i);
    const v = parseInt(el.value || "0", 10);
    el.value = v + delta;
    calcAll();
  }

  // ============================
  // UIæ“ä½œï¼ˆé–‹å‚¬ãƒ»Rãƒ»è·é›¢ï¼‰
  // ============================
  function selectKaisai(btn, name){
    document.querySelectorAll("#kaisaiButtons button").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    selectedKaisai = name;
    loadData();
  }

  function selectRace(btn, num){
    document.querySelectorAll("#raceButtons button").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    selectedRace = num;
    loadData();
  }

  function updateDistance(){
    const v = distance.value;
    distanceLabel.textContent = `${v}ï¼ˆ${v*100}mï¼‰`;
  }

  function changeDistance(d){
    let v = parseInt(distance.value) + d;
    if(v < 10) v = 10;
    if(v > 36) v = 36;
    distance.value = v;
    updateDistance();
    calcAll();
    saveData();
  }

  function changeField(id, delta){
    const el = document.getElementById(id);
    let v = parseInt(el.value || "0", 10);
    if(isNaN(v)) v = 0;
    v += delta;
    if(id === "runners"){
      if(v < 1) v = 1;
      if(v > 18) v = 18;
    }
    el.value = v;
    if(id === "runners") onRunnersChanged();
  }

  function onRunnersChanged(){
    normalizeRunnersInput();
    updateWakuAll();
    calcAll();
    saveData();
  }

  function normalizeRunnersInput(){
    let v = parseInt(runners.value || "12", 10);
    if(isNaN(v)) v = 12;
    if(v < 1) v = 1;
    if(v > 18) v = 18;
    runners.value = v;
  }

  // ============================
  // ãƒˆã‚°ãƒ«
  // ============================
  function getKey(){
    return STORAGE_PREFIX + "_" + selectedKaisai + "_" + selectedRace;
  }

  function setToggle(group, value){
    document.querySelectorAll(".toggle-"+group).forEach(b=>{
      b.classList.toggle("active", b.dataset.value === value);
    });
    if(group === "buy") buyState = value;
    if(group === "hit") hitState = value;
    updatePayoutEnabled();
    saveData();
  }

  function updatePayoutEnabled(){
    const payoutEl = document.getElementById("payout");
    if(!payoutEl) return;
    const isHit = (hitState === "yes");
    payoutEl.disabled = !isHit;
    if(!isHit){
      payoutEl.value = "0";
    }else{
      if(payoutEl.value === "" || payoutEl.value == null) payoutEl.value = "0";
    }
  }

  function getPaceLabel(value){
    switch(Number(value)){
      case 1: return "ã‚¹ãƒ­ãƒ¼";
      case 2: return "mã‚¹ãƒ­ãƒ¼";
      case 3: return "ãƒŸãƒ‰ãƒ«";
      case 4: return "mãƒã‚¤";
      case 5: return "ãƒã‚¤";
      default: return "";
    }
  }
  function updatePaceLabel(){
    const p = document.getElementById("pace");
    const label = document.getElementById("paceLabel");
    if(p && label) label.textContent = getPaceLabel(p.value);
  }

  // ============================
  // å€¤å–å¾—
  // ============================
  function nRunners(){ return parseInt(document.getElementById("runners").value || "12", 10) }

  function body_i(i){return document.getElementById("body_"+i).value || 0}
  function time_i(i){return document.getElementById("time_"+i).value || 0}
  function jockey_i(i){return document.getElementById("jockey_"+i).value || 0}
  function style_i(i){return document.getElementById("style_"+i).value || ""}
  function jisseki_i(i){
    const v = Number(document.getElementById("jisseki_"+i).value || 0);
    return (isFinite(v) ? v : 0);
  }

  // ============================
  // æ è¨ˆç®—ï¼ˆã‚ãªãŸã®ãƒ«ãƒ¼ãƒ«ï¼‰
  // ============================
  function buildCaps(n){
    n = Math.max(1, Math.min(18, Number(n)||12));
    const cap = Array(8).fill(0);

    if(n <= 8){
      for(let w=1; w<=n; w++) cap[w-1] = 1;
      return cap;
    }

    for(let w=1; w<=8; w++) cap[w-1] = 1;
    let extra = n - 8;

    for(let k=0; k<Math.min(extra,8); k++){
      const w = 8 - k;
      cap[w-1] = 2;
    }

    if(n === 17){
      cap[7] = 3;
    }
    if(n === 18){
      cap[7] = 3;
      cap[6] = 3;
    }
    return cap;
  }

  function wakuOfHorse(horseNo, n){
    horseNo = Number(horseNo);
    n = Math.max(1, Math.min(18, Number(n)||12));
    if(horseNo < 1 || horseNo > n) return 0;

    const cap = buildCaps(n);
    let acc = 0;
    for(let w=1; w<=8; w++){
      acc += cap[w-1];
      if(horseNo <= acc) return w;
    }
    return 0;
  }

  function renderWakuCell(i, waku){
    const el = document.getElementById("waku_"+i);
    if(!el) return;
    if(!waku){
      el.innerHTML = "";
      return;
    }
    const info = WAKU_COLORS[waku] || {css:"#888"};
    const tc = textColorForBg(info.css);
    el.innerHTML = `<span class="waku-badge" style="background:${info.css};color:${tc}">${waku}</span>`;
  }

  function updateWakuAll(){
    const n = nRunners();
    for(let i=1;i<=18;i++){
      const w = wakuOfHorse(i, n);
      renderWakuCell(i, w);
      const row = document.getElementById("row_"+i);
      if(row){
        row.classList.toggle("inactive", i>n);
      }
    }
  }

  // ============================
  // æ ãƒ»è„šè‰²è£œæ­£å€¤
  // ============================
  function getDistanceKey(){
    return String(Number(distance.value) * 100);
  }

  function getBaseBiasArray(){
    const place = selectedKaisai;
    const surf  = surface.value;
    const distKey = getDistanceKey();
    const obj = COURSE_DICT?.[place]?.[surf]?.[distKey];
    const name = obj?.baseBias || "NEUTRAL";
    return BIAS[name] || BIAS.NEUTRAL;
  }

  function getRawBiasForHorse(i){
    const n = nRunners();
    if(i > n) return 0;

    const waku = wakuOfHorse(i, n);
    if(!waku) return 0;

    const baseArr = getBaseBiasArray();
    const base = baseArr[waku-1] ?? 0;

    const st = style_i(i);
    const styleArr = STYLE[st] || STYLE[""];
    const styleBase = styleArr[waku-1] ?? 0;

    const mul = paceStyleMultiplier(st, pace.value);
    const styleAdj = styleBase * mul;

    return (base + styleAdj) * BIAS_K;
  }

  // ============================
  // é¨æ‰‹ç‚¹ï¼ˆå·®åˆ†æ³•ï¼‰
  // ============================
  function calcJockeyPointsDiff(temp){
    const jVals = temp.map(x=>Number(x.j)).filter(v=>!isNaN(v) && v>0);
    if(jVals.length === 0) return temp.map(()=>0);

    const mean = jVals.reduce((a,b)=>a+b,0) / jVals.length;
    const diffs = temp.map(x=>{
      const v = Number(x.j);
      if(isNaN(v) || v<=0) return 0;
      return Math.max(0, v - mean);
    });

    const dMax = Math.max(...diffs);
    if(!isFinite(dMax) || dMax <= 0) return temp.map(()=>0);

    const s = diffs.map(d => d / dMax);
    const sumS = s.reduce((a,b)=>a+b,0);
    if(sumS <= 0) return temp.map(()=>0);

    return s.map(v => v / sumS * WEIGHT.JOCKEY);
  }

  // ============================
  // è¨ˆç®—ï¼ˆé¦¬åˆè¨ˆãƒ»é¨æ‰‹ç‚¹ãƒ»ç·åˆç‚¹ãƒ»é †ä½ãƒ»Softmaxï¼‰
  // ============================
  function calcAll(){
    if(!selectedKaisai || !selectedRace){
      updateWakuAll();
      return;
    }

    normalizeRunnersInput();
    updateWakuAll();

    const n = nRunners();
    let sumHorseRaw = 0;

    const temp = [];
    const horseRawArr = Array(18).fill(0);

    for(let i=1;i<=18;i++){
      if(i > n){
        temp.push({rawHorse:0, j:parseFloat(jockey_i(i))});
        continue;
      }

      const b = +body_i(i);
      const t = +time_i(i);
      const p = +jisseki_i(i);

      const rawBase = b + t + p;
      const rawBias = getRawBiasForHorse(i);
      const rawHorse = rawBase + rawBias;

      horseRawArr[i-1] = rawHorse;
      sumHorseRaw += rawHorse;
      temp.push({rawHorse, j:parseFloat(jockey_i(i))});
    }

    const jsArr = calcJockeyPointsDiff(temp);

    const res = [];
    for(let i=1;i<=18;i++){
      const idx = i-1;

      if(i > n){
        document.getElementById("pastTotal_"+i).value = "";
        document.getElementById("jockeyP_"+i).value   = "";
        document.getElementById("total_"+i).value     = "";
        document.getElementById("softmax_"+i).value   = "";
        continue;
      }

      const hs = sumHorseRaw ? (horseRawArr[idx] / sumHorseRaw * WEIGHT.HORSE) : 0;
      const js = jsArr[idx] || 0;
      const tot = hs + js;

      document.getElementById("pastTotal_"+i).value = (hs>0 ? hs.toFixed(1) : "");
      document.getElementById("jockeyP_"+i).value   = (js>0 ? js.toFixed(1) : "");
      document.getElementById("total_"+i).value     = (tot>0 ? tot.toFixed(1) : "");

      if(tot > 0){
        res.push({n:i, v:tot, hs, js});
      }
    }

    const sorted = res.slice().sort((a,b)=>b.v - a.v);

    rankList.innerHTML = sorted
      .map((r,i)=>`${i+1}ä½ ${r.n}ç•ª`)
      .join("<br>");

    avgScore.textContent = formatTop3Display(sorted);
    updateAvoidLabel(sorted);
    calcSoftmax(sorted);

    saveData();
  }

  function formatTop3Display(sorted){
    if(sorted.length === 0) return "-";
    const out = [];
    let rank = 0;
    let prev = null;
    for(let i=0;i<sorted.length;i++){
      const cur = sorted[i];
      if(prev === null || cur.v !== prev){
        rank++;
        prev = cur.v;
      }
      if(rank > 3) break;
      out.push(`${cur.n}ç•ª(${cur.v.toFixed(1)})`);
    }
    return out.join(" / ");
  }

  function updateAvoidLabel(sorted){
    const el = document.getElementById("avoidLabel");
    if(!el) return;
    el.innerHTML = "";

    if(sorted.length < 1) return;

    const top1 = sorted[0];
    const top2 = sorted[1] || null;

    const gap = (top2 ? (top1.v - top2.v) : 999);
    const isDango = (top2 && gap < THRESH.GAP_DANGO);

    const jockeyRatio = (top1.v > 0 ? (top1.js / top1.v) : 0);
    const isJockeyHigh = (jockeyRatio > THRESH.JOCKEY_RATIO_MAX);

    const isUmaLow = (top1.hs < THRESH.UMA_MIN);

    const chips = [];
    if(isUmaLow)     chips.push(`<span class="chip chip-stop">ğŸš« é¦¬ä½</span>`);
    if(isJockeyHigh) chips.push(`<span class="chip chip-stop">ğŸš« é¨æ‰‹é«˜</span>`);
    if(isDango)      chips.push(`<span class="chip chip-warn">âš  å›£å­</span>`);

    el.innerHTML = chips.join("");
  }

  function calcSoftmax(sorted){
    for(let i=1;i<=18;i++){
      document.getElementById("softmax_"+i).value = "";
    }
    if(sorted.length === 0) return;

    const values = sorted.map(x=>x.v);
    const maxVal = Math.max(...values);
    const exps = values.map(v=>Math.exp(v - maxVal));
    const sumExp = exps.reduce((a,b)=>a+b,0);

    sorted.forEach((r, idx)=>{
      const p = exps[idx] / sumExp;
      document.getElementById("softmax_"+r.n).value = p.toFixed(3);
    });
  }

  // ============================
  // ã‚³ãƒ”ãƒ¼ï¼šç·åˆç‚¹
  // ============================
  async function copyTotals(){
    normalizeRunnersInput();
    const n = nRunners();
    const arr = [];
    for(let i=1;i<=n;i++){
      const v = document.getElementById("total_"+i).value;
      arr.push(v ? String(v) : "0");
    }
    const text = arr.join(" ");
    try{
      await navigator.clipboard.writeText(text);
      alert("ç·åˆç‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰");
    }catch(e){
      prompt("ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯ã€ã“ã“ã‹ã‚‰æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š", text);
    }
  }

  // ============================
  // ä¸€æ‹¬è²¼ä»˜ï¼ˆé¨æ‰‹ / å®Ÿç¸¾ï¼‰
  // ============================
  let batchMode = null; // "jockey" | "jisseki"

  function openBatchModal(mode){
    batchMode = mode;
    const bd = document.getElementById("modalBackdrop");
    const title = document.getElementById("modalTitle");
    const desc  = document.getElementById("modalDesc");
    const txt   = document.getElementById("modalText");
    const hint  = document.getElementById("modalHint");

    normalizeRunnersInput();
    const n = nRunners();

    txt.value = "";

    if(mode === "jockey"){
      title.textContent = "é¨æ‰‹(è¤‡å‹ç‡) ä¸€æ‹¬è²¼ä»˜";
      desc.textContent =
        "GPTã‹ã‚‰å‡ºã¦ããŸè¤‡å‹ç‡ï¼ˆä¾‹ï¼š0.23ï¼‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚åŒºåˆ‡ã‚Šã¯æ”¹è¡Œ/ã‚¹ãƒšãƒ¼ã‚¹/ã‚«ãƒ³ãƒã©ã‚Œã§ã‚‚OKã€‚\n" +
        "ç©ºæ¬„ã«ã—ãŸã„å ´æ‰€ã¯ã€Œ-ã€ã‚’å…¥ã‚Œã‚‹ã¨é£›ã°ã›ã¾ã™ã€‚\n" +
        "â€» 23 ã‚„ 23.4 ã®ã‚ˆã†ãªæ•°å­—ã¯è‡ªå‹•ã§ 0.23 / 0.234 ã«å¤‰æ›ã—ã¾ã™ã€‚";
      txt.placeholder = "ä¾‹ï¼‰0.23 0.18 - 0.31 ...";
      hint.textContent = `ä¸Šã‹ã‚‰ ${n} é ­åˆ†ã¾ã§é †ç•ªã«å…¥ã‚Šã¾ã™ã€‚`;
    }else{
      title.textContent = "å®Ÿç¸¾(ãƒã‚¤ãƒ³ãƒˆ) ä¸€æ‹¬è²¼ä»˜";
      desc.textContent =
        "å„é¦¬ã®ã€Œå®Ÿç¸¾ãƒã‚¤ãƒ³ãƒˆã€ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚\n" +
        "1åˆ—ã§ã‚‚ã€2åˆ—ï¼ˆé¦¬ç•ªï¼‹ãƒã‚¤ãƒ³ãƒˆï¼‰ã§ã‚‚OKã§ã™ã€‚è¡Œã«æ•°å­—ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯ã€Œæœ€å¾Œã®æ•°ã€ã‚’ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦æ¡ç”¨ã—ã¾ã™ã€‚\n" +
        "ä¾‹ï¼‰\n" +
        "18\n16\n10\nâ€¦\n" +
        "ã¾ãŸã¯\n" +
        "1 18\n2 16\n3 10\nâ€¦";
      txt.placeholder = "ä¾‹ï¼‰\n18\n16\n10\n0\n...";
      hint.textContent = `ä¸Šã‹ã‚‰ ${n} é ­åˆ†ã¾ã§é †ç•ªã«å…¥ã‚Šã¾ã™ã€‚`;
    }

    bd.style.display = "flex";
    setTimeout(()=>txt.focus(), 0);
  }

  function closeBatchModal(){
    document.getElementById("modalBackdrop").style.display = "none";
    batchMode = null;
  }

  function closeModalIfBackdrop(e){
    if(e.target && e.target.id === "modalBackdrop") closeBatchModal();
  }

  function tokenize(text){
    return text
      .replace(/[ï¼Œã€]/g, ",")
      .replace(/\r/g, "\n")
      .split(/[\n]+/)
      .map(s=>s.trim())
      .filter(s=>s.length>0);
  }

  function parseRateToken(tok){
    if(tok === "-" || tok === "ï¼") return null;
    const t = tok.replace("%","");
    const v = Number(t);
    if(!isFinite(v) || v<=0) return null;
    if(v > 1 && v <= 100) return (v/100);
    return v;
  }

  function parseLastNumber(tok){
    if(tok === "-" || tok === "ï¼") return null;
    const nums = String(tok).match(/-?\d+(\.\d+)?/g);
    if(!nums || nums.length===0) return null;
    const last = Number(nums[nums.length-1]);
    if(!isFinite(last)) return null;
    return last;
  }

  function applyBatch(){
    if(!batchMode) return;
    normalizeRunnersInput();
    const n = nRunners();
    const text = document.getElementById("modalText").value || "";

    if(batchMode === "jockey"){
      // jockey ã¯æ”¹è¡Œ/ã‚¹ãƒšãƒ¼ã‚¹/ã‚«ãƒ³ãƒå…¨éƒ¨è¨±å¯
      const toks = text
        .replace(/[ï¼Œã€]/g, ",")
        .replace(/\r/g, "\n")
        .split(/[\s,]+/)
        .map(s=>s.trim())
        .filter(s=>s.length>0);

      for(let i=1;i<=n;i++){
        const tok = toks[i-1];
        if(tok == null) continue;
        const val = parseRateToken(tok);
        document.getElementById("jockey_"+i).value = (val == null ? "" : String(val));
      }
      closeBatchModal();
      calcAll();
      saveData();
      return;
    }

    if(batchMode === "jisseki"){
      // å®Ÿç¸¾ã¯ã€Œ1è¡Œ=1é ­ã€æƒ³å®šï¼ˆ1åˆ—/2åˆ—ã©ã£ã¡ã§ã‚‚OKï¼‰
      const lines = tokenize(text);
      for(let i=1;i<=n;i++){
        const line = lines[i-1];
        if(line == null) continue;
        const val = parseLastNumber(line);
        document.getElementById("jisseki_"+i).value = (val == null ? "" : String(Math.round(val)));
      }
      closeBatchModal();
      calcAll();
      saveData();
      return;
    }
  }

  // ============================
  // ä¿å­˜/èª­è¾¼
  // ============================
  function saveData(){
    if(!selectedKaisai || !selectedRace) return;

    const d = {
      date      : dateInput.value,
      kaisai    : selectedKaisai,
      race      : selectedRace,
      surface   : surface.value,
      distance  : distance.value,
      runners   : runners.value,
      pace      : pace.value,
      pickHorse : pickHorse.value,

      buy       : buyState,
      hit       : hitState,
      payout    : payout.value,

      fin1      : fin1.value,
      fin2      : fin2.value,
      fin3      : fin3.value,

      skip      : !!skipRace.checked,

      oddsLow   : oddsLow.value,
      oddsHigh  : oddsHigh.value,
      memo      : memo.value,

      horses    : []
    };

    for(let i=1;i<=18;i++){
      d.horses.push({
        style     : style_i(i),
        body      : body_i(i),
        time      : time_i(i),
        jockey    : jockey_i(i),
        jisseki   : document.getElementById("jisseki_"+i).value || "",
        umaTotal  : document.getElementById("pastTotal_"+i).value || "",
        kisyuPoint: document.getElementById("jockeyP_"+i).value || "",
        total     : document.getElementById("total_"+i).value || ""
      });
    }

    localStorage.setItem(getKey(), JSON.stringify(d));
  }

  function loadData(){
    // ç”»é¢ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ•ã‚©ï¼‰
    dateInput.value = "";
    skipRace.checked = false;

    surface.value = "ãƒ€ãƒ¼ãƒˆ";
    distance.value = 20;
    updateDistance();

    runners.value = 12;
    updateWakuAll();

    pace.value = 3;
    updatePaceLabel();

    pickHorse.value = 1;

    oddsLow.value = "";
    oddsHigh.value = "";
    memo.value = "";

    fin1.value = "";
    fin2.value = "";
    fin3.value = "";

    buyState = "";
    hitState = "";
    document.querySelectorAll(".toggle-buy,.toggle-hit").forEach(b=>b.classList.remove("active"));

    payout.value = "0";
    updatePayoutEnabled();

    for(let i=1;i<=18;i++){
      document.getElementById("style_"+i).value = "";
      document.getElementById("body_"+i).value = "";
      document.getElementById("time_"+i).value = 0;
      document.getElementById("jockey_"+i).value = "";
      document.getElementById("jisseki_"+i).value = "";

      document.getElementById("pastTotal_"+i).value = "";
      document.getElementById("jockeyP_"+i).value   = "";
      document.getElementById("total_"+i).value     = "";
      document.getElementById("softmax_"+i).value   = "";
    }

    rankList.innerHTML = "";
    avgScore.textContent = "-";
    document.getElementById("avoidLabel").innerHTML = "";

    const raw = localStorage.getItem(getKey());
    if(!raw){
      updateWakuAll();
      return;
    }

    const d = JSON.parse(raw);

    dateInput.value      = d.date      || "";
    skipRace.checked     = !!d.skip;

    surface.value        = d.surface   || "ãƒ€ãƒ¼ãƒˆ";
    distance.value       = d.distance  || 20;
    updateDistance();

    runners.value        = d.runners   || 12;
    normalizeRunnersInput();
    updateWakuAll();

    pace.value           = d.pace      || 3;
    updatePaceLabel();

    pickHorse.value      = d.pickHorse || 1;

    oddsLow.value        = d.oddsLow   || "";
    oddsHigh.value       = d.oddsHigh  || "";
    memo.value           = d.memo      || "";

    fin1.value           = d.fin1      || "";
    fin2.value           = d.fin2      || "";
    fin3.value           = d.fin3      || "";

    buyState             = d.buy       || "";
    hitState             = d.hit       || "";

    payout.value         = (d.payout!=null && d.payout!=="") ? d.payout : "0";

    if(buyState) setToggle("buy", buyState);
    if(hitState) setToggle("hit", hitState);
    updatePayoutEnabled();

    (d.horses || []).forEach((h, idx)=>{
      const n = idx + 1;
      document.getElementById("style_"+n).value   = h.style || "";
      document.getElementById("body_"+n).value    = h.body  || "";
      document.getElementById("time_"+n).value    = h.time  || 0;
      document.getElementById("jockey_"+n).value  = h.jockey|| "";

      // æ–°å½¢å¼ãŒã‚ã‚‹ãªã‚‰ãã‚Œã€ãªã‘ã‚Œã°æ—§å½¢å¼ï¼ˆpast1-3ï¼‰ã‹ã‚‰æ¨å®š
      if(h.jisseki != null && h.jisseki !== ""){
        document.getElementById("jisseki_"+n).value = h.jisseki;
      }else if(h.past1 != null || h.past2 != null || h.past3 != null){
        const sum = legacyPastSum(h.past1, h.past2, h.past3);
        document.getElementById("jisseki_"+n).value = String(sum);
      }else{
        document.getElementById("jisseki_"+n).value = "";
      }
    });

    calcAll();
  }

  function resetData(){
    if(confirm("å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
      Object.keys(localStorage)
        .filter(k=>k.startsWith(STORAGE_PREFIX))
        .forEach(k=>localStorage.removeItem(k));
      location.reload();
    }
  }

  // ============================
  // CSVå‡ºåŠ›/èª­è¾¼ï¼ˆäº’æ›é‡è¦–ï¼‰
  // ============================
  function csvEscape(v){
    if(v===null || v===undefined) return "";
    v = String(v).replace(/"/g,'""');
    return /[",\n]/.test(v) ? `"${v}"` : v;
  }

  function exportCSV(){
    if(!selectedKaisai){
      alert("é–‹å‚¬ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    const date  = dateInput.value || "no-date";
    const place = selectedKaisai;

    const rows = [];
    const header = [
      "æ—¥ä»˜","é–‹å‚¬","ãƒ¬ãƒ¼ã‚¹ç•ªå·","ã‚³ãƒ¼ã‚¹","è·é›¢m","é ­æ•°",
      "é¦¬ç•ª","æ ","è„šè‰²","é¦¬ä½“","ã‚¿ã‚¤ãƒ ","é¨æ‰‹",
      "å®Ÿç¸¾",
      "é¦¬åˆè¨ˆ80","é¨æ‰‹ç‚¹20","ç·åˆç‚¹100",
      "ãƒšãƒ¼ã‚¹äºˆæƒ³","æŒ‡åé¦¬ç•ª","ä¸å‚åŠ ","è³¼å…¥","çš„ä¸­","é…å½“",
      "1ç€","2ç€","3ç€",
      "è¤‡å‹ã‚ªãƒƒã‚ºä¸‹","è¤‡å‹ã‚ªãƒƒã‚ºä¸Š","ãƒ¡ãƒ¢"
    ];
    rows.push(header.join(","));

    for(let r=1;r<=12;r++){
      const key = `${STORAGE_PREFIX}_${place}_${r}`;
      const data = JSON.parse(localStorage.getItem(key) || "null");
      if(!data || !data.horses) continue;

      const n = Math.max(1, Math.min(18, Number(data.runners || 12)));
      for(let i=1;i<=18;i++){
        const h = data.horses[i-1] || {};
        const w = wakuOfHorse(i, n);

        // æ—§ãƒ‡ãƒ¼ã‚¿ã—ã‹ãªã„å ´åˆã¯past1-3ã‹ã‚‰å‡ºåŠ›å€¤ã‚’ä½œã‚‹
        const jissekiOut = (h.jisseki!=null && h.jisseki!=="") ? h.jisseki : legacyPastSum(h.past1, h.past2, h.past3);

        const row = [
          csvEscape(data.date),
          csvEscape(data.kaisai),
          csvEscape(data.race),
          csvEscape(data.surface),
          csvEscape(Number(data.distance)*100),
          csvEscape(n),

          csvEscape(i),
          csvEscape(w || ""),
          csvEscape(h.style || ""),
          csvEscape(h.body),
          csvEscape(h.time),
          csvEscape(h.jockey),

          csvEscape(jissekiOut),

          csvEscape(h.umaTotal || ""),
          csvEscape(h.kisyuPoint || ""),
          csvEscape(h.total || ""),

          csvEscape(data.pace),
          csvEscape(data.pickHorse),

          csvEscape(data.skip ? "1" : "0"),
          csvEscape(data.buy),
          csvEscape(data.hit),
          csvEscape(data.payout ?? "0"),

          csvEscape(data.fin1 || ""),
          csvEscape(data.fin2 || ""),
          csvEscape(data.fin3 || ""),

          csvEscape(data.oddsLow),
          csvEscape(data.oddsHigh),
          csvEscape(data.memo)
        ];
        rows.push(row.join(","));
      }
    }

    if(rows.length === 1){
      alert("ã“ã®é–‹å‚¬ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }

    const csvContent = rows.join("\r\n");
    const blob = new Blob([csvContent], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.download = `keiba_saturday_${date}_${place}_ALL.csv`;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  document.getElementById("csvFile").addEventListener("change",e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => importCSV(ev.target.result);
    reader.readAsText(file,"utf-8");
  });

  function importCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const headers = lines[0].split(",");
    const rows = lines.slice(1).map(l=>l.split(","));

    const idx = name => headers.indexOf(name);
    const pickIdx = (names) => {
      for(const n of names){
        const i = idx(n);
        if(i >= 0) return i;
      }
      return -1;
    };

    const map = {
      date   : pickIdx(["æ—¥ä»˜"]),
      place  : pickIdx(["é–‹å‚¬"]),
      race   : pickIdx(["ãƒ¬ãƒ¼ã‚¹ç•ªå·"]),
      course : pickIdx(["ã‚³ãƒ¼ã‚¹"]),
      dist   : pickIdx(["è·é›¢m"]),
      runners: pickIdx(["é ­æ•°"]),
      horse  : pickIdx(["é¦¬ç•ª"]),
      waku   : pickIdx(["æ "]),
      style  : pickIdx(["è„šè‰²"]),
      body   : pickIdx(["é¦¬ä½“"]),
      time   : pickIdx(["ã‚¿ã‚¤ãƒ "]),
      jockey : pickIdx(["é¨æ‰‹"]),
      jisseki: pickIdx(["å®Ÿç¸¾","å®Ÿç¸¾ç‚¹","éå»ç‚¹"]),

      // æ—§CSVå¯¾å¿œï¼ˆéå»1-3ï¼‰
      p1     : pickIdx(["éå»1"]),
      p2     : pickIdx(["éå»2"]),
      p3     : pickIdx(["éå»3"]),

      uma    : pickIdx(["é¦¬åˆè¨ˆ80","é¦¬åˆè¨ˆ70"]),
      kisyu  : pickIdx(["é¨æ‰‹ç‚¹20","é¨æ‰‹ç‚¹30"]),
      total  : pickIdx(["ç·åˆç‚¹100"]),

      pace   : pickIdx(["ãƒšãƒ¼ã‚¹äºˆæƒ³"]),
      pick   : pickIdx(["æŒ‡åé¦¬ç•ª"]),
      skip   : pickIdx(["ä¸å‚åŠ "]),
      buy    : pickIdx(["è³¼å…¥"]),
      hit    : pickIdx(["çš„ä¸­"]),
      payout : pickIdx(["é…å½“"]),
      fin1   : pickIdx(["1ç€"]),
      fin2   : pickIdx(["2ç€"]),
      fin3   : pickIdx(["3ç€"]),
      oddsL  : pickIdx(["è¤‡å‹ã‚ªãƒƒã‚ºä¸‹"]),
      oddsH  : pickIdx(["è¤‡å‹ã‚ªãƒƒã‚ºä¸Š"]),
      memo   : pickIdx(["ãƒ¡ãƒ¢"]),
    };

    rows.forEach(r=>{
      const race = Number(map.race>=0 ? r[map.race] : 0);
      if(!race || race<1 || race>12) return;

      const place = map.place>=0 ? r[map.place] : "";
      const key = `${STORAGE_PREFIX}_${place}_${race}`;

      const baseJson = `{
        "date":"", "kaisai":"${place}", "race":${race},
        "surface":"ãƒ€ãƒ¼ãƒˆ", "distance":20, "runners":12, "pace":3,
        "pickHorse":1, "skip":false,
        "buy":"", "hit":"", "payout":"0",
        "fin1":"", "fin2":"", "fin3":"",
        "oddsLow":"", "oddsHigh":"", "memo":"",
        "horses":[]
      }`;

      const data = JSON.parse(localStorage.getItem(key) || baseJson);

      const i = Number(map.horse>=0 ? r[map.horse] : 0) - 1;
      if(i < 0 || i >= 18) return;

      data.date      = map.date>=0 ? r[map.date] : (data.date||"");
      data.surface   = map.course>=0 ? (r[map.course] || "ãƒ€ãƒ¼ãƒˆ") : (data.surface||"ãƒ€ãƒ¼ãƒˆ");
      data.distance  = map.dist>=0 ? (Number(r[map.dist]) / 100 || data.distance || 20) : (data.distance||20);
      data.runners   = map.runners>=0 ? (Number(r[map.runners]) || data.runners || 12) : (data.runners||12);
      data.pace      = map.pace>=0 ? (r[map.pace] || data.pace || 3) : (data.pace||3);
      data.pickHorse = map.pick>=0 ? (r[map.pick] || data.pickHorse || 1) : (data.pickHorse||1);

      data.skip      = (map.skip>=0 ? (r[map.skip]==="1") : (data.skip||false));

      data.buy       = map.buy>=0 ? r[map.buy] : (data.buy||"");
      data.hit       = map.hit>=0 ? r[map.hit] : (data.hit||"");
      data.payout    = map.payout>=0 ? (r[map.payout] || "0") : (data.payout||"0");

      data.fin1      = map.fin1>=0 ? (r[map.fin1] || "") : (data.fin1||"");
      data.fin2      = map.fin2>=0 ? (r[map.fin2] || "") : (data.fin2||"");
      data.fin3      = map.fin3>=0 ? (r[map.fin3] || "") : (data.fin3||"");

      data.oddsLow   = map.oddsL>=0 ? r[map.oddsL] : (data.oddsLow||"");
      data.oddsHigh  = map.oddsH>=0 ? r[map.oddsH] : (data.oddsHigh||"");
      data.memo      = map.memo>=0 ? r[map.memo] : (data.memo||"");

      if(!data.horses[i]) data.horses[i] = {};

      // å®Ÿç¸¾ã®å–ã‚Šæ–¹ï¼šæ–°CSVã®å®Ÿç¸¾åˆ—ãŒå„ªå…ˆã€ç„¡ã‘ã‚Œã°æ—§CSVã®éå»1-3ã‹ã‚‰æ¨å®š
      let jis = "";
      if(map.jisseki>=0 && r[map.jisseki] != null && r[map.jisseki] !== ""){
        jis = r[map.jisseki];
      }else{
        const p1 = (map.p1>=0 ? r[map.p1] : 0);
        const p2 = (map.p2>=0 ? r[map.p2] : 0);
        const p3 = (map.p3>=0 ? r[map.p3] : 0);
        jis = String(legacyPastSum(p1,p2,p3));
      }

      data.horses[i] = {
        style     : map.style>=0 ? (r[map.style] || "") : (data.horses[i].style || ""),
        body      : map.body>=0 ? r[map.body] : "",
        time      : map.time>=0 ? r[map.time] : 0,
        jockey    : map.jockey>=0 ? r[map.jockey] : "",
        jisseki   : jis,
        umaTotal  : map.uma>=0 ? r[map.uma] : (data.horses[i].umaTotal||""),
        kisyuPoint: map.kisyu>=0 ? r[map.kisyu] : (data.horses[i].kisyuPoint||""),
        total     : map.total>=0 ? r[map.total] : (data.horses[i].total||""),
      };

      localStorage.setItem(key, JSON.stringify(data));
    });

    alert("é–‹å‚¬ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å¾©å…ƒã—ã¾ã—ãŸ");
  }

  // åˆæœŸè¡¨ç¤º
  updateDistance();
  updatePaceLabel();
  normalizeRunnersInput();
  updateWakuAll();
  updatePayoutEnabled();
</script>

</body>
</html>

